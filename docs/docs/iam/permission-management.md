# 权限管理详细指南

## 概述

权限管理是IAM模块的核心功能，提供了细粒度的访问控制能力。通过权限管理，管理员可以精确控制用户对平台各种资源的操作权限，确保系统安全性和合规性。

## 权限模型

### RBAC模型

平台采用基于角色的访问控制（Role-Based Access Control，RBAC）模型：

```
用户（User） → 角色（Role） → 权限（Permission） → 资源（Resource）
```

**核心概念：**
- **用户**：访问主体，通过拥有角色获得权限
- **角色**：权限的集合，分配给用户
- **权限**：对特定资源的操作许可
- **资源**：被保护的对象，如集群、工作空间、应用等

### 权限继承

平台支持多层级的权限继承：

```
Platform (平台级)
  ├── Cluster (集群级)
  │   ├── Workspace (工作空间级)
  │   │   └── Namespace (项目级)
  └── NodeGroup (节点组级)
```

**继承规则：**
- 上层权限自动包含下层权限
- 同层权限相互独立
- 用户可以拥有多个层级的角色

## 权限类型

### 操作权限

平台支持以下基本操作权限：

**读取权限（Get/List）**
- 查看资源详情
- 列出资源列表
- 查看资源配置
- 查看资源状态

**创建权限（Create）**
- 创建新资源
- 初始化资源配置
- 设置资源参数

**更新权限（Update）**
- 修改资源配置
- 更新资源状态
- 调整资源参数

**删除权限（Delete）**
- 删除资源
- 清理资源数据
- 移除资源关联

### 资源权限

平台支持以下资源类型的权限控制：

**基础设施资源**
- 集群（Cluster）
- 节点（Node）
- 节点组（NodeGroup）
- 工作空间（Workspace）
- 项目（Namespace）

**应用资源**
- 应用（Application）
- 部署（Deployment）
- 服务（Service）
- 配置（ConfigMap）
- 密钥（Secret）

**管理资源**
- 用户（User）
- 角色（Role）
- 权限模板（RoleTemplate）

**监控资源**
- 监控数据（Monitoring）
- 告警规则（Alert）
- 日志（Log）

## 权限模板

### 模板概述

权限模板是预定义的权限集合，用于快速配置角色权限。平台提供了丰富的权限模板，覆盖���种使用场景。

### 模板分类

**用户管理模板**
```
users-manager：用户管理权限
- 用户CRUD操作
- 用户角色管理
- 用户状态管理

users-viewer：用户查看权限
- 查看用户列表
- 查看用户详情
- 查看用户角色
```

**角色管理模板**
```
roles-manager：角色管理权限
- 角色CRUD操作
- 角色权限配置
- 角色绑定管理

roles-viewer：角色查看权限
- 查看角色列表
- 查看角色详情
- 查看角色权限
```

**集群管理模板**
```
clusters-manager：集群管理权限
- 集群CRUD操作
- 集群配置管理
- 集群状态监控

clusters-viewer：集群查看权限
- 查看集群列表
- 查看集群详情
- 查看集群状态
```

**工作空间管理模板**
```
workspaces-manager：工作空间管理权限
- 工作空间CRUD操作
- 工作空间成员管理
- 工作空间配额管理

workspaces-viewer：工作空间查看权限
- 查看工作空间列表
- 查看工作空间详情
- 查看工作空间配额
```

**应用管理模板**
```
apps-manager：应用管理权限
- 应用部署和管理
- 应用配置修改
- 应用状态监控

apps-viewer：应用查看权限
- 查看应用列表
- 查看应用详情
- 查看应用状态
```

**监控管理模板**
```
monitoring-manager：监控管理权限
- 访问监控数据
- 配置告警规则
- 管理监控面板

monitoring-viewer：监控查看权限
- 查看监控数据
- 查看告警信息
- 查看监控面板
```

### 模板使用

**单个模板使用**
1. 在角色权限配置对话框中
2. 勾选需要的权限模板
3. 系统自动应用模板包含的所有权限

**多个模板组合**
1. 可以同时选择多个权限模板
2. 权限会自动合并，不会重复
3. 实现灵活的权限组合

**模板叠加效果**
```
示例：开发人员角色
- apps-manager（应用管理）
- namespaces-viewer（项目查看）
- monitoring-viewer（监控查看）

= 开发人员可以管理应用，查看项目信息，查看监控数据
```

## 权限配置

### 角色权限配置

**配置步骤**
1. 进入"访问控制" → "角色管理"
2. 找到要配置的角色，点击"编辑权限"
3. 在权限模板列表中选择合适的模板
4. 点击"确定"保存配置

**配置原则**
- 最小权限：只授予完成工作所需的最小权限
- 职责分离：将敏感操作分散到不同角色
- 权限审计：定期审查权限配置是否合理

### 用户权限配置

**配置方式**
用户通过获得角色而获得权限，不需要直接配置用户权限。

**配置步骤**
1. 进入"访问控制" → "用户管理"
2. 找到要配置的用户，点击"管理角色"
3. 为用户分配合适的角色
4. 用户自动获得角色包含的所有权限

**权限叠加**
- 一个用户可以拥有多个角色
- 用户的所有角色权限会叠加
- 不同层级的角色可以同时存在

## 权限验证

### 权限检查流程

当用户访问资源时，系统执行以下权限检查：

```
1. 身份验证
   ├─ 验证用户Token是否有效
   ├─ 检查用户账号状态
   └─ 获取用户基本信息

2. 角色解析
   ├─ 获取用户的所有角色
   ├─ 解析角色对应的权限
   └─ 合并所有角色权限

3. 权限匹配
   ├─ 检查操作类型权限
   ├─ 检查资源类型权限
   ├─ 检查资源范围权限
   └─ 验证权限约束条件

4. 访问决策
   ├─ 权限通过：允许访问
   ├─ 权限不足：拒绝访问
   └─ 记录访问日志
```

### 权限边界

**层级边界**
- 平台级角色只能在平台范围内生效
- 集群级角色只能在指定集群内生效
- 工作空间级角色只能在指定工作空间内生效

**操作边界**
- 只读权限不能执行写操作
- 部分权限不能操作未授权的资源
- 跨资源操作需要多个权限

**时间边界**
- 权限变更需要重新登录才能生效
- 临时权限会自动过期
- 会话超时后需要重新验证

## 权限测试

### 权限测试工具

平台提供了权限测试工具，帮助验证权限配置是否正确。

**使用步骤**
1. 进入"访问控制" → "权限测试"
2. 选择要测试的用户
3. 选择要测试的资源和操作
4. 执行测试，查看测试结果

**测试结果**
- ✅ 权限通过：用户有权限执行该操作
- ❌ 权限拒绝：用户无权限执行该操作
- ℹ️ 权限详情：显示具体的权限信息

### 测试场景

**场景1：新用户权限验证**
- 测试用户是否能够访问基本资源
- 验证角色分配是否正确生效
- 确认权限范围是否符合预期

**场景2：权限变更验证**
- 测试权限变更后是否立即生效
- 验证权限叠加是否正确
- 确认权限边界是否有效

**场景3：权限问题排查**
- 当用户报告权限问题时使用
- 快速定位权限配置错误
- 验证权限修复效果

## 权限审计

### 审计内容

平台记录所有权限相关的操作，包括：

**权限分配**
- 用户角色分配
- 角色权限配置
- 权限模板使用

**权限使用**
- 用户访问记录
- 权限验证结果
- 访问拒绝记录

**权限变更**
- 权限配置修改
- 角色权限调整
- 权限模板更新

### 审计日志

**日志内容**
- 操作时间
- 操作用户
- 操作类型
- 操作资源
- 操作结果
- 权限信息

**日志用途**
- 安全审计：定期审查权限使用情况
- 问题排查：分析权限相关的故障
- 合规检查：验证权限配置符合规范

## 权限最佳实践

### 权限设计原则

1. **最小权限原则**
   - 只授予用户完成工作所需的最小权限
   - 避免过度授权造成安全风险
   - 定期清理不需要的权限

2. **职责分离原则**
   - 将敏感操作分散到不同角色
   - 防止单个用户拥有过多权限
   - 实现权限相互制衡

3. **权限分层原则**
   - 按照管理层级设计权限
   - 上层权限包含下层权限
   - 避免权限重复配置

### 权限管理建议

1. **使用权限模板**
   - 优先使用系统提供的权限模板
   - 通过组合模板实现复杂权限
   - 避免手动配置细粒度权限

2. **定期权限审查**
   - 每季度审查角色权限配置
   - 检查用户角色分配是否合理
   - 清理不需要的权限和角色

3. **权限变更管理**
   - 重要权限变更需要审批
   - 测试权限变更的影响
   - 记录权限变更原因

4. **监控权限使用**
   - 监控异常权限使用行为
   - 定期查看访问审计日志
   - 发现和预防安全风险

### 权限配置示例

**开发人员角色**
```
权限模板组合：
- apps-manager：管理应用
- namespaces-viewer：查看项目
- monitoring-viewer：查看监控

能力说明：
- 可以部署和管理应用
- 可以查看项目信息
- 可以查看监控数据
- 不能修改集群配置
- 不能管理其他用户
```

**运维人员角色**
```
权限模板组合：
- clusters-manager：管理集群
- workspaces-manager：管理工作空间
- monitoring-manager：管理监控
- apps-manager：管理应用

能力说明：
- 可以管理集群和节点
- 可以管理工作空间
- 可以查看和管理监控告警
- 可以处理应用故障
```

**审计人员角色**
```
权限模板组合：
- users-viewer：查看用户
- roles-viewer：查看角色
- clusters-viewer：查看集群
- monitoring-viewer：查看监控

能力说明：
- 可以查看所有用户和角色信息
- 可以查看集群状态
- 可以查看监控数据
- 不能修改任何配置
- 可以访问审计日志
```

## 权限故障排查

### 常见问题

**问题1：用户无法访问资源**
- 检查用户是否有相应的角色
- 验证角色权限配置是否正确
- 确认用户是否重新登录
- 使用权限测试工具验证

**问题2：权限变更不生效**
- 确认用户是否重新登录
- 检查权限配置是否正确保存
- 验证角色作用范围是否正确
- 查看系统错误日志

**问题3：权限过大或过小**
- 使用权限测试工具验证权限
- 审查角色的权限模板配置
- 检查用户的所有角色
- 调整权限模板组合

**问题4：权限冲突**
- 检查用户是否拥有多个角色
- 验证角色权限是否有冲突
- 确认权限继承关系
- 调整角色分配策略

## 相关文档
- [IAM概述](./iam-overview.md)
- [用户管理指南](./user-management.md)
- [角色管理指南](./role-management.md)
- [访问控制最佳实践](./access-control-best-practices.md)