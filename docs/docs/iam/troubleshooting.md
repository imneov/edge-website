# IAM故障排查指南

## 概述

本文档提供了边缘智能管理平台IAM模块的故障排查指南，帮助管理员快速定位和解决常见的IAM问题。

## 通用排查流程

### 标准排查步骤

当遇到IAM相关问题时，按照以下标准流程进行排查：

```
1. 问题确认
   ├─ 明确问题现象
   ├─ 收集错误信息
   ├─ 确定问题范围
   └─ 评估影响程度

2. 信息收集
   ├─ 查看浏览器控制台错误
   ├─ 检查网络请求响应
   ├─ 收集用户操作步骤
   └─ 记录系统状态

3. 原因分析
   ├─ 分析错误日志
   ├─ 检查系统配置
   ├─ 验证用户权限
   └─ 检查网络连接

4. 解决方案
   ├─ 应用修复方案
   ├─ 验证修复效果
   ├─ 恢复正常服务
   └─ 记录处理过程
```

## 用户管理问题

### 问题1：无法创建用户

**现象描述**
- 点击"新建用户"后没有反应
- 创建用户时显示错误信息
- 用户创建后不在列表中显示

**可能原因**
- 用户名已存在
- 邮箱格式不正确
- 网络连接问题
- 权限不足

**排查步骤**
1. 检查浏览器控制台是否有错误信息
2. 查看网络请求的响应状态
3. 验证当前用户是否有创建用户的权限
4. 检查用户名是否符合命名规范

**解决方案**
```bash
# 检查用户名是否已存在
# 通过API或界面搜索用户名

# 验证邮箱格式
# 确保邮箱格式正确，例如：user@example.com

# 检查权限
# 确认当前用户具有 users-manager 或 platform-admin 角色

# 重试创建
# 刷新页面后重新尝试创建用户
```

### 问题2：用户无法登录

**现象描述**
- 用户输入正确的用户名密码但无法登录
- 登录后立即被登出
- 显示"账号不存在"或"密码错误"

**可能原因**
- 用户状态为禁用
- 密码不正确
- 账号被锁定
- 会话配置问题

**排查步骤**
1. 检查用户状态是否为"活跃"
2. 验证密码是否正确
3. 查看登录审计日志
4. 检查是否有系统错误

**解决方案**
```bash
# 检查用户状态
# 在用户管理中查看用户状态
# 如果状态为"禁用"，需要先启用用户

# 重置密码
# 使用"重置密码"功能为用户设置新密码
# 通知用户使用新密码登录

# 检查角色绑定
# 确认用户是否分配了角色
# 没有角色的用户可能无法正常使用系统

# 查看审计日志
# 检查用户登录历史
# 发现异常登录行为
```

### 问题3：用户列表显示不完整

**现象描述**
- 用户列表显示的用户数量与实际不符
- 某些用户无法在列表中找到
- 分页显示异常

**可能原因**
- 搜索过滤条件
- 分页参数错误
- 缓存问题
- 数据同步延迟

**排查步骤**
1. 清空搜索框查看所有用户
2. 检查分页参数是否正确
3. 刷新页面重新加载数据
4. 查看后端日志确认数据

**解决方案**
```bash
# 清除搜索条件
# 清空搜索框内容
# 点击"刷新"按钮重新加载

# 检查分页设置
# 确认当前页码和每页显示数量
# 尝试切换页码查看

# 清除缓存
# 在浏览器中清除缓存
# 或使用无痕模式重新登录

# 重新登录
# 退出当前账号
# 重新登录系统
```

## 角色管理问题

### 问题1：无法创建角色

**现象描述**
- 点击"创建角色"后没有反应
- 创建角色时显示错误信息
- 角色创建后不在列表中显示

**可能原因**
- 角色名已存在
- 权限不足
- 配置参数错误
- 系统限制

**排查步骤**
1. 检查浏览器控制台错误
2. 验证当前用户权限
3. 检查角色名是否符合规范
4. 查看系统错误日志

**解决方案**
```bash
# 检查角色名
# 确保角色名全局唯一
# 角色名只能包含小写字母、数字、连字符

# 验证权限
# 确认当前用户具有 roles-manager 或 platform-admin 角色

# 检查配置
# 确认角色类型和作用范围配置正确
# 验证权限模板选择是否有效

# 重试创建
# 刷新页面后重新尝试创建角色
```

### 问题2：角色权限不生效

**现象描述**
- 用户分配了角色但没有相应权限
- 修改角色权限后用户权限没有变化
- 权限验证失败

**可能原因**
- 用户未重新登录
- 权限缓存未更新
- 角色配置错误
- 权限作用范围不匹配

**排查步骤**
1. 确认用户是否重新登录
2. 检查角色权限配置
3. 验证角色作用范围
4. 使用权限测试工具验证

**解决方案**
```bash
# 重新登录
# 让用户退出当前会话
# 重新登录系统获取最新权限

# 检查角色配置
# 进入角色详情页面
# 验证权限模板是否正确选择

# 验证作用范围
# 确认角色的作用范围与资源匹配
# 例如：workspace角色不能管理cluster资源

# 清除缓存
# 清除浏览器缓存
# 清除系统权限缓存（需要管理员权限）

# 使用权限测试工具
# 在权限测试页面验证用户权限
# 确认权限配置是否正确
```

### 问题3：无法删除角色

**现象描述**
- 删除角色时显示错误信息
- 删除按钮不可点击
- 删除后角色仍然存在

**可能原因**
- 角色有用户绑定
- 系统内置角色
- 权限不足
- 依赖关系限制

**排查步骤**
1. 检查角色是否有用户绑定
2. 确认是否为系统内置角色
3. 验证当前用户权限
4. 查看系统错误日志

**解决方案**
```bash
# 解除用户绑定
# 查看角色的用户绑定列表
# 移除所有用户的该角色绑定

# 检查角色类型
# 系统内置角色（如platform-admin）无法删除
# 自定义角色可以删除

# 验证权限
# 确认当前用户具有删除角色的权限
# roles-manager或platform-admin角色可以删除角色

# 强制删除（谨慎使用）
# 如果确认需要删除，可以先解绑所有用户
# 然后执行删除操作
```

## 权限问题

### 问题1：权限验证失败

**现象描述**
- 用户访问资源时显示"权限不足"
- 明明有权限但无法操作
- 权限测试结果与实际不符

**可能原因**
- 权限配置错误
- 角色未正确分配
- 权限缓存问题
- 作用范围不匹配

**排查步骤**
1. 使用权限测试工具验证
2. 检查用户的角色绑定
3. 验证角色权限配置
4. 确认资源的作用范围

**解决方案**
```bash
# 使用权限测试工具
# 进入"访问控制" → "权限测试"
# 选择用户、资源、操作进行测试
# 查看测试结果和权限详情

# 检查用户角色
# 进入用户详情页面
# 查看用户的所有角色绑定
# 确认角色是否正确分配

# 验证角色权限
# 进入角色详情页面
# 查看角色的权限配置
# 确认权限模板是否正确

# 检查作用范围
# 验证角色的作用范围与操作资源匹配
# 例如：workspace角色只能操作指定workspace的资源

# 重新登录
# 让用户退出并重新登录
# 获取最新的权限配置
```

### 问题2：权限过大或过小

**现象描述**
- 用户拥有过大的权限，可以访问不应该访问的资源
- 用户权限过小，无法完成必要的工作
- 权限配置与预期不符

**可能原因**
- 角色设计不合理
- 权限模板选择错误
- 多角色权限叠加
- 权限配置错误

**排查步骤**
1. 审查用户的角色分配
2. 分析每个角色的权限
3. 检查权限叠加效果
4. 使用权限测试工具验证

**解决方案**
```bash
# 审查用户角色
# 列出用户的所有角色
# 分析每个角色的权限范围
# 识别权限过大的角色

# 调整角色分配
# 移除不必要的角色
# 添加缺少的角色
# 使用最小权限原则

# 优化角色配置
# 修改角色的权限模板
# 减少或增加权限
# 遵循最小权限原则

# 创建自定义角色
# 如果现有角色不满足需求
# 创建新的自定义角色
# 精确配置权限范围
```

## 性能问题

### 问题1：用户列表加载缓慢

**现象描述**
- 用户列表加载时间过长
- 分页切换响应慢
- 搜索响应延迟

**可能原因**
- 用户数量过多
- 网络延迟
- 服务器负载高
- 查询效率低

**排查步骤**
1. 检查网络连接状态
2. 查看服务器资源使用情况
3. 分析查询性能
4. 检查缓存配置

**解决方案**
```bash
# 优化查询条件
# 使用搜索功能精确查找用户
# 避免加载大量数据

# 使用分页
# 合理设置每页显示数量
# 避免一次性加载过多数据

# 优化网络
# 检查网络连接质量
# 使用稳定的网络环境

# 服务器优化
# 增加服务器资源
# 优化数据库查询
# 启用缓存机制
```

### 问题2：权限验证响应慢

**现象描述**
- 访问资源时权限验证延迟
- 权限测试工具响应慢
- 登录后权限初始化慢

**可能原因**
- 权限数据量大
- 权限计算复杂
- 缓存未命中
- 服务器负载高

**排查步骤**
1. 检查用户角色数量
2. 分析权限计算复杂度
3. 查看缓存命中率
4. 监控服务器性能

**解决方案**
```bash
# 简化角色配置
# 减少用户的角色数量
# 优化权限模板组合
# 避免过度复杂的权限配置

# 启用缓存
# 确保权限缓存正常工作
# 提高缓存命中率
# 减少权限计算开销

# 服务器优化
# 增加服务器资源
# 优化权限验证算法
# 提高系统性能
```

## 系统错误

### 问题1：界面显示错误

**现象描述**
- 页面显示异常
- 按钮无法点击
- 表格显示错乱

**可能原因**
- 浏览器兼容性问题
- JavaScript错误
- CSS加载失败
- 网络资源加载失败

**排查步骤**
1. 检查浏览器控制台错误
2. 验证浏览器版本
3. 清除浏览器缓存
4. 尝试其他浏览器

**解决方案**
```bash
# 检查浏览器
# 使用推荐版本的浏览器
# Chrome、Firefox、Edge等现代浏览器

# 清除缓存
# 清除浏览器缓存和Cookie
# 使用Ctrl+Shift+Delete清除缓存

# 禁用插件
# 暂时禁用浏览器插件
# 排除插件干扰

# 尝试其他浏览器
# 使用不同的浏览器访问
# 排除浏览器兼容性问题
```

### 问题2：API请求失败

**现象描述**
- 界面操作没有响应
- 网络请求返回错误
- 数据加载失败

**可能原因**
- 网络连接问题
- 服务器错误
- API端点变更
- 权限不足

**排查步骤**
1. 检查网络连接状态
2. 查看浏览器网络请求
3. 检查服务器日志
4. 验证用户权限

**解决方案**
```bash
# 检查网络连接
# 确认网络连接正常
# 检查防火墙设置
# 验证DNS解析

# 查看网络请求
# 打开浏览器开发者工具
# 查看Network标签页
# 检查请求状态和响应

# 检查服务器状态
# 确认服务器运行正常
# 查看服务器错误日志
# 验证API端点可访问

# 验证权限
# 确认用户有执行操作的权限
# 检查Token是否有效
# 重新登录获取新Token
```

## 日志分析

### 错误日志位置

**前端日志**
```bash
# 浏览器控制台
# 按F12打开开发者工具
# 查看Console标签页的错误信息

# 网络请求
# 查看Network标签页
# 检查API请求的响应状态
```

**后端日志**
```bash
# API服务器日志
# /Users/neov/src/github.com/edgekeel/apiserver/logs/apiserver.log

# 控制器日志
# /Users/neov/src/github.com/edgekeel/apiserver/logs/controller.log
```

### 常见错误信息

**权限相关错误**
```
"Unauthorized" - 用户未认证或Token无效
"Forbidden" - 用户权限不足
"Permission denied" - 权限验证失败
```

**用户相关错误**
```
"User already exists" - 用户已存在
"User not found" - 用户不存在
"Invalid email format" - 邮箱格式无效
```

**角色相关错误**
```
"Role already exists" - 角色已存在
"Role not found" - 角色不存在
"Role is in use" - 角色正在使用中
"Cannot delete built-in role" - 无法删除内置角色
```

## 获取帮助

### 自助服务

1. **查看文档**
   - IAM概述文档
   - 用户管理指南
   - 角色管理指南
   - 权限管理指南

2. **使用工具**
   - 权限测试工具
   - 审计日志查询
   - 系统状态监控

3. **社区支持**
   - 用户论坛
   - 知识库
   - FAQ页面

### 联系支持

当自助服务无法解决问题时，请联系技术支持：

**联系信息**
- 技术支持邮箱：support@theriseunion.io
- 客服热线：400-xxx-xxxx
- 在线客服：工作日 9:00-18:00

**提供信息**
- 问题描述和现象
- 错误信息和截图
- 操作步骤和重现方法
- 系统版本和环境信息
- 已尝试的解决方法

## 预防措施

### 日常维护

1. **定期检查**
   - 每周检查系统日志
   - 每月审查用户权限
   - 每季度评估角色配置

2. **备份策略**
   - 定期备���用户数据
   - 备份角色配置
   - 保留审计日志

3. **性能监控**
   - 监控系统性能
   - 跟踪错误率
   - 分析使用趋势

### 健康检查

**日常检查项**
- [ ] 用户登录是否正常
- [ ] 权限验证是否正常
- [ ] 界面响应是否正常
- [ ] 日志记录是否正常
- [ ] 备份是否完成

**定期检查项**
- [ ] 用户权限审查
- [ ] 角色配置评估
- [ ] 安全策略更新
- [ ] 性能优化调整
- [ ] 文档更新维护

## 相关文档
- [IAM概述](./iam-overview.md)
- [用户管理指南](./user-management.md)
- [角色管理指南](./role-management.md)
- [权限管理指南](./permission-management.md)
- [访问控制最佳实践](./access-control-best-practices.md)