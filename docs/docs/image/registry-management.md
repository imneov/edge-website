# 镜像源管理

## 概述

镜像源管理模块提供了统一的容器镜像仓库凭证管理功能，支持多种主流镜像仓库，包括 Harbor、Docker Hub、阿里云容器镜像服务等。通过集中管理镜像仓库的访问凭证，简化了边缘节点访问私有镜像仓库的配置过程。

## 功能特性

### 支持的镜像仓库类型

1. **Harbor**
   - 企业级 Docker 镜像仓库
   - 支持镜像签名、扫描等安全特性
   - 提供丰富的访问控制和审计功能

2. **Docker Hub**
   - 最大的公共镜像仓库
   - 支持私有镜像仓库
   - 全球 CDN 加速

3. **阿里云容器镜像服务**
   - 国内访问速度快
   - 与阿里云产品深度集成
   - 支持镜像加速器

4. **其他标准 Docker Registry**
   - 支持 Docker Registry v2 API
   - 兼容各类标准镜像仓库

### 核心功能

#### 1. 镜像源配置
- **域名配置**：配置镜像仓库的访问地址
- **认证信息**：配置用户名和密码凭证
- **提供者选择**：选择镜像仓库的类型
- **命名空间隔离**：在不同命名空间配置独立的镜像源

#### 2. 连接验证
- **实时测试**：测试镜像仓库连接是否正常
- **凭证验证**：验证用户名密码是否正确
- **状态记录**：记录验证结果和时间戳
- **错误提示**：提供详细的连接失败原因

#### 3. 批量管理
- **批量删除**：一次删除多个镜像源
- **批量选择**：支持全选和条件选择
- **操作确认**：防止误操作的安全确认机制

#### 4. 信息管理
- **别名设置**：为镜像源设置易识别的别名
- **描述信息**：添加镜像源的详细描述
- **元数据管理**：通过 Kubernetes annotations 管理元信息

## 操作指南

### 添加镜像源

#### 步骤 1：导航到镜像源管理页面

1. 登录边缘计算平台
2. 在左侧导航栏选择「镜像管理」→「镜像源管理」
3. 进入镜像源列表页面

#### 步骤 2：点击添加按钮

点击页面右上角的「添加镜像源」按钮，打开创建对话框。

#### 步骤 3：填写镜像源信息

在创建对话框中填写以下信息：

| 字段 | 说明 | 示例 | 必填 |
|------|------|------|------|
| 名称 | 镜像源的唯一标识 | `harbor-prod` | 是 |
| 显示名称 | 镜像源的显示别名 | `生产环境 Harbor` | 否 |
| 命名空间 | 镜像源所属命名空间 | `default` | 是 |
| 描述 | 镜像源的详细描述 | `生产环境主镜像仓库` | 否 |
| 域名 | 镜像仓库的访问地址 | `harbor.example.com` | 是 |
| 用户名 | 登录用户名 | `admin` | 是 |
| 密码 | 登录密码 | `********` | 是 |
| 提供者 | 镜像仓库类型 | `Harbor` | 是 |

#### 步骤 4：测试连接

点击「测试连接」按钮，验证配置是否正确：
- ✅ **连接成功**：表示配置正确，可以保存
- ❌ **连接失败**：检查配置信息，修正错误后重试

#### 步骤 5：保存配置

确认信息无误后，点击「确定」保存镜像源配置。

### 管理现有镜像源

#### 查看镜像源列表

镜像源列表页面显示以下信息：

| 列名 | 说明 |
|------|------|
| 选择 | 多选框，用于批量操作 |
| 名称 | 镜像源的名称和别名 |
| 命名空间 | 镜像源所属的命名空间 |
| 域名 | 镜像仓库的访问地址 |
| 用户名 | 登录用户名 |
| 提供者 | 镜像仓库类型 |
| 状态 | 连接状态（连接成功/连接失败/未测试） |
| 操作 | 可执行的操作菜单 |

#### 测试连接

1. 点击镜像源右侧的「操作」菜单（⋯）
2. 选择「测试连接」
3. 系统会自动验证连接状态
4. 验证结果会更新到「状态」列

#### 编辑镜像源信息

1. 点击镜像源右侧的「操作」菜单（⋯）
2. 选择「编辑信息」
3. 在弹出的对话框中修改显示名称和描述
4. 点击「保存」完成编辑

**注意**：不能修改域名、用户名、密码等核心配置。如需修改，请删除后重新创建。

#### 删除镜像源

##### 单个删除

1. 点击镜像源右侧的「操作」菜单（⋯）
2. 选择「删除」
3. 在确认对话框中输入镜像源名称
4. 点击「确定」完成删除

##### 批量删除

1. 勾选要删除的镜像源
2. 点击工具栏的「删除选中」按钮
3. 在确认对话框中输入删除数量
4. 点击「确定」完成批量删除

**警告**：删除镜像源后，使用该凭证的镜像将无法正常拉取。

### 按命名空间过滤

镜像源支持跨命名空间管理：

1. 在页面左上角的命名空间选择器中选择目标命名空间
2. 选择「全部项目」可以查看所有命名空间的镜像源
3. 选择特定命名空间只查看该命名空间下的镜像源

### 搜索镜像源

在搜索框中输入关键词，可以搜索以下字段：
- 镜像源名称
- 显示名称（别名）
- 域名

## 镜像源状态说明

### 状态类型

| 状态 | 图标 | 说明 |
|------|------|------|
| 未测试 | ⚪ | 新创建的镜像源，尚未测试连接 |
| 连接成功 | 🟢 | 镜像源连接正常，凭证配置正确 |
| 连接失败 | 🔴 | 无法连接到镜像仓库，请检查配置 |

### 查看验证详情

鼠标悬停在状态徽章上，可以查看：
- 验证结果的详细消息
- 验证时间戳
- 错误原因（如果连接失败）

## 最佳实践

### 1. 命名规范

**命名规则**：
- 使用小写字母和连字符
- 包含环境信息（如 `prod`、`dev`）
- 包含仓库类型（如 `harbor`、`dockerhub`）

**示例**：
- `harbor-prod`：生产环境 Harbor
- `dockerhub-dev`：开发环境 Docker Hub
- `aliyun-staging`：预发布环境阿里云

### 2. 安全建议

- **使用专用账户**：为镜像平台创建专用的镜像仓库账户
- **最小权限原则**：只授予必要的仓库访问权限
- **定期更换密码**：定期更新镜像仓库密码
- **监控访问日志**：定期检查镜像仓库的访问日志

### 3. 环境隔离

为不同环境配置独立的镜像源：

```
开发环境 (dev-namespace)
├── harbor-dev
├── dockerhub-dev
└── aliyun-dev

测试环境 (test-namespace)
├── harbor-test
├── dockerhub-test
└── aliyun-test

生产环境 (prod-namespace)
├── harbor-prod
├── dockerhub-prod
└── aliyun-prod
```

### 4. 连接验证

- **创建后立即验证**：创建镜像源后立即测试连接
- **定期验证状态**：定期检查所有镜像源的连接状态
- **故障及时处理**：发现连接失败及时处理，避免影响应用部署

### 5. 成本优化

- **优先使用内网地址**：如果镜像仓库在云服务商内部，使用内网地址
- **配置镜像加速器**：为 Docker Hub 等公网镜像仓库配置加速器
- **清理无用镜像源**：定期清理不再使用的镜像源

## 常见问题

### Q1: 为什么连接测试失败？

**可能原因**：
1. 域名配置错误
2. 用户名或密码错误
3. 网络连接问题
4. 镜像仓库服务不可用

**解决方法**：
1. 检查域名配置是否正确
2. 确认用户名密码是否正确
3. 使用 `ping` 或 `telnet` 测试网络连接
4. 联系镜像仓库管理员确认服务状态

### Q2: 如何更新镜像源的密码？

**方法**：
1. 删除现有的镜像源
2. 重新创建镜像源并填写新密码
3. 测试连接确保新密码正确

### Q3: 能否在多个命名空间共享镜像源？

**答案**：
可以。镜像源是命名空间级别的资源，需要在每个命名空间中分别创建。如果需要在多个命名空间使用相同的镜像源，可以在每个命名空间中创建相同配置的镜像源。

### Q4: 删除镜像源会影响正在运行的应用吗？

**答案**：
不会直接影响正在运行的应用，因为镜像已经拉取到本地节点。但会影响：
- 新部署的应用无法拉取镜像
- 镜像更新无法同步
- 节点重启后无法重新拉取镜像

### Q5: 如何监控镜像源的连接状态？

**方法**：
1. 定期查看镜像源列表的状态列
2. 使用「测试连接」功能手动验证
3. 设置告警规则监控连接状态

## 技术实现

### 数据结构

镜像源使用 Kubernetes 自定义资源（CRD）存储：

```yaml
apiVersion: image.theriseunion.io/v1alpha1
kind: RegistrySecret
metadata:
  name: harbor-prod
  namespace: default
  annotations:
    theriseunion.io/display-name: "生产环境 Harbor"
    theriseunion.io/description: "生产环境主镜像仓库"
    theriseunion.io/domain: "harbor.example.com"
    theriseunion.io/username: "admin"
    theriseunion.io/provider: "harbor"
    theriseunion.io/verify-status: "success"
    theriseunion.io/verify-message: "连接成功"
    theriseunion.io/verify-timestamp: "1704676800000"
spec:
  domain: "harbor.example.com"
  username: "admin"
  password: "<base64-encoded>"
  provider: "harbor"
```

### API 端点

- **列表**：`GET /oapis/image.theriseunion.io/v1alpha1/namespaces/{namespace}/registry-secrets`
- **详情**：`GET /oapis/image.theriseunion.io/v1alpha1/namespaces/{namespace}/registry-secrets/{name}`
- **创建**：`POST /oapis/image.theriseunion.io/v1alpha1/namespaces/{namespace}/registry-secrets`
- **删除**：`DELETE /oapis/image.theriseunion.io/v1alpha1/namespaces/{namespace}/registry-secrets/{name}`
- **验证**：`POST /oapis/image.theriseunion.io/v1alpha1/namespaces/{namespace}/registry-secrets/{name}/verify`

## 相关文档

- [镜像仓库管理](./repository-management.md)
- [镜像安全与认证](./security-authentication.md)
- [故障排查指南](./troubleshooting.md)