# 租户权限管理指南

## 概述

租户权限管理提供了基于角色的访问控制（RBAC）功能，允许管理员精细地控制租户空间内不同用户的访问权限。通过合理的权限配置，可以确保资源的安全性，同时提高团队协作效率。

## 权限模型

### RBAC架构

#### 核心概念
- **用户 (User)**: 系统中的个人账户
- **角色 (Role)**: 权限的集合
- **角色绑定 (RoleBinding)**: 用户与角色的关联
- **权限 (Permission)**: 对特定资源的操作许可

#### 权限继承
- **角色继承**: 角色可以继承其他角色的权限
- **资源层级**: 权限可以基于资源层级设置
- **权限叠加**: 用户多个角色的权限会叠加

## 角色管理

### 角色类型

#### 内置角色

##### 管理员角色 (workspace-admin)
- **完整权限**: 拥有租户空间的所有权限
- **用户管理**: 可以邀请、移除成员
- **角色管理**: 可以创建和管理角色
- **资源管理**: 可以管理所有资源
- **应用部署**: 可以部署和管理应用

##### 查看着角色 (workspace-viewer)
- **只读权限**: 只能查看资源
- **无修改权限**: 不能修改任何配置
- **无部署权限**: 不能部署应用
- **监控查看**: 可以查看监控数据

##### 普通成员角色 (workspace-regular)
- **基础权限**: 可以查看和管理基础资源
- **项目创建**: 可以创建项目
- **应用部署**: 可以在项目内部署应用
- **无用户管理**: 不能管理其他用户

##### 自助配置角色 (workspace-self-provisioner)
- **项目创建**: 可以独立创建项目
- **资源管理**: 可以管理自己的项目资源
- **应用部署**: 可以在自己的项目内部署应用
- **有限管理**: 权限仅限于自己的资源

#### 自定义角色

##### 创建自定义角色
1. 进入租户角色管理页面
2. 分析权限需求
3. 创建新的角色定义
4. 配置具体权限
5. 分配给用户

##### 角色配置要素
- **角色名称**: 唯一的角色标识符
- **显示名称**: 用户友好的角色名称
- **描述信息**: 角色的用途和权限范围
- **权限规则**: 具体的权限配置
- **作用范围**: 权限的作用范围

### 角色管理操作

#### 查看角色列表

##### 访问路径
- **导航**: 租户空间 → 租户设置 → 租户空间角色
- **URL**: `/tenant/[tenant-id]/roles`
- **权限要求**: 管理员权限

##### 列表信息
- **角色名称**: 角色的唯一标识符
- **显示名称**: 用户友好的角色名称
- **描述信息**: 角色的功能描述
- **作用范围**: 角色、绑定、用户
- **创建时间**: 角色的创建时间
- **内置标识**: 是否为系统内置角色

#### 角色详情

##### 基本信息
- **角色标识**: 角色的唯一标识符
- **显示名称**: 角色的显示名称
- **角色类型**: 内置或自定义
- **描述信息**: 角色的详细描述

##### 权限配置
- **API组**: 权限适用的API组
- **资源类型**: 权限适用的资源类型
- **操作动词**: 允许的操作（get、list、create、update、delete）
- **资源名称**: 特定资源的名称限制

##### 绑定用户
- **用户列表**: 当前拥有该角色的用户
- **绑定时间**: 用户获得角色的时间
- **绑定状态**: 角色绑定的当前状态

## 成员管理

### 成员管理功能

#### 成员列表

##### 访问路径
- **导航**: 租户空间 → 租户设置 → 租户空间成员
- **URL**: `/tenant/[tenant-id]/members`
- **权限要求**: 管理员权限

##### 成员信息
- **用户名称**: 成员的用户名
- **显示名称**: 成员的显示名称
- **邮箱地址**: 成员的联系邮箱
- **当前角色**: 成员在租户空间中的角色
- **加入时间**: 成员加入租户空间的时间
- **活跃状态**: 成员的当前活跃状态

#### 成员操作

##### 搜索成员
- **关键词搜索**: 支持用户名和显示名称搜索
- **实时过滤**: 输入即过滤，无需按回车
- **角色过滤**: 按角色类型过滤成员
- **状态过滤**: 按活跃状态过滤成员

##### 批量操作
- **批量选择**: 支持多选成员进行批量操作
- **批量修改角色**: 同时修改多个成员的角色
- **批量移除**: 同时移除多个成员
- **操作确认**: 批量操作需要确认

### 邀请成员

#### 邀请流程

##### 1. 打开邀请对话框
- **入口**: 点击"邀请成员"按钮
- **权限检查**: 系统会检查当前用户权限
- **角色加载**: 自动加载可用角色列表

##### 2. 填写邀请信息
- **用户名**: 输入要邀请的用户名（支持多个）
- **角色选择**: 为用户选择初始角色
- **权限说明**: 查看角色权限说明

##### 3. 发送邀请
- **验证用户**: 系统验证用户是否存在
- **创建绑定**: 为用户创建角色绑定
- **成功反馈**: 邀请成功后的反馈信息

#### 邀请规则

##### 用户限制
- **已存在用户**: 不能重复邀请已存在的成员
- **用户验证**: 只能邀请系统中存在的用户
- **批量邀请**: 支持一次邀请多个用户

##### 角色限制
- **角色选择**: 必须为用户选择一个角色
- **角色权限**: 初始角色决定了用户的权限
- **后续调整**: 邀请后可以调整用户角色

### 成员角色管理

#### 修改成员角色

##### 修改流程
1. **找到成员**: 在成员列表中找到目标成员
2. **打开操作菜单**: 点击���员右侧的操作按钮
3. **选择修改角色**: 点击"修改角色"选项
4. **选择新角色**: 在对话框中选择新的角色
5. **确认修改**: 确认角色修改操作

##### 修改影响
- **权限变更**: 用户权限立即变更
- **资源访问**: 新权限立即生效
- **操作记录**: 记录角色修改操作
- **通知用户**: (可选) 通知用户角色变更

#### 移除成员

##### 移除流程
1. **找到成员**: 在成员列表中找到目标成员
2. **打开操作菜单**: 点击成员右侧的操作按钮
3. **选择移除成员**: 点击"移除成员"选项
4. **确认移除**: 确认移除操作
5. **立即生效**: 移除立即生效

##### 移除影响
- **访问权限**: 用户立即失去租户空间访问权限
- **资源绑定**: 清除用户的所有资源绑定
- **运行应用**: 用户部署的应用继续运行
- **操作记录**: 记录成员移除操作

## 权限配置

### 权限规则

#### 权限定义结构
```yaml
rules:
- apiGroups: [""] # API组，""表示核心API
  resources: ["pods"] # 资源类型
  verbs: ["get", "list", "watch"] # 操作动词
```

#### 常用API组
- **""**: 核心API（Pod、Service等）
- **"apps"**: 应用API（Deployment、StatefulSet等）
- **"batch"**: 批处理API（Job、CronJob等）
- **"networking.k8s.io"**: 网络API（Ingress等）
- **"scope.theriseunion.io"**: 租户空间API

#### 常用操作动词
- **get**: 获取单个资源
- **list**: 列出资源集合
- **watch**: 监听资源变化
- **create**: 创建新资源
- **update**: 更新现有资源
- **patch**: 部分更新资源
- **delete**: 删除资源

### 权限范围

#### 资源级权限
- **特定资源**: 对特定名称资源的权限
- **资源类型**: 对某种类型资源的权限
- **命名空间**: 在特定命名空间内的权限

#### 操作级权限
- **只读权限**: 仅查看权限
- **管理权限**: 完整的管理权限
- **特殊操作**: 特定操作的权限

### 权限最佳实践

#### 权限设计原则
1. **最小权限**: 只授予必要的最小权限
2. **职责分离**: 不同角色承担不同职责
3. **权限审计**: 定期审计权限分配
4. **权限回收**: 及时回收不需要的权限

#### 角色设计建议
1. **角色明确**: 每个角色有明确的职责
2. **权限适度**: 避免权限过大或过小
3. **角色层次**: 建立合理的角色层次
4. **命名规范**: 使用清晰的命名规范

## 安全策略

### 访问控制

#### 身份验证
- **登录认证**: 用户登录时的身份验证
- **Token管理**: 安全的Token管理机制
- **会话管理**: 安全的会话管理
- **多因素认证**: (可选) 多因素认证支持

#### 权限验证
- **操作验证**: 每次操作都进行权限验证
- **资源隔离**: 严格的资源间权限隔离
- **API保护**: 所有API都受权限保护
- **审计日志**: 记录所有权限相关操作

### 安全最佳实践

#### 用户安全
1. **强密码**: 要求使用强密码
2. **定期更换**: 定期更换密码
3. **账户锁定**: 多次登录失败锁定账户
4. **会话超时**: 设置合理的会话超时时间

#### 权限安全
1. **权限审计**: 定期审计权限分配
2. **权限回收**: 及时回收不需要的权限
3. **敏感操作**: 敏感操作需要额外确认
4. **操作日志**: 记录所有敏感操作

#### 数据安全
1. **数据加密**: 敏感数据加密存储
2. **传输加密**: 使用HTTPS加密传输
3. **备份策略**: 定期备份重要数据
4. **灾难恢复**: 制定灾难恢复计划

## 常见问题

### Q: 如何为用户分配多个角色？
A: 当前版本每个用户在同一租户空间只能有一个角色，可以通过创建包含多个权限的自定义角色来实现类似效果。

### Q: 用户忘记密码怎么办？
A: 用户需要通过系统管理员的密码重置功能重置密码，租户管理员无法重置用户密码。

### Q: 如何批量管理成员？
A: 可以通过选择多个成员进行批量操作，支持批量修改角色和批量移除。

### Q: 权限变更后多久生效？
A: 权限变更通常会立即生效，但在某些情况下可能会有短暂的缓存延迟。

### Q: 如何查看用户的操作历史？
A: 可以通过审计日志功能查看用户的操作历史，需要管理员权限。

## 相关文档

- [租户空间概览](./tenant-overview.md)
- [租户管理指南](./tenant-management.md)
- [安全配置指南](./security-setup.md)
- [审计日志使用](./audit-logging.md)