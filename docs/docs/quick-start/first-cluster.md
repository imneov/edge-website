---
sidebar_position: 3
title: 创建第一个集群
---

# 创建第一个集群

本文档将指导管理员如何在边缘平台中添加和管理第一个 Kubernetes 集群。

## 📋 前置条件

在开始之前，请确保：

- ✅ 已完成[首次登录](./first-login.md)
- ✅ 具有**平台管理员**权限
- ✅ 已有运行中的 Kubernetes 集群
- ✅ 有集群的 kubeconfig 文件

:::info 集群要求
支持 Kubernetes 1.24+ 版本，推荐使用 OpenYurt 1.6+ 以获得更好的边缘计算能力。
:::

## 🎯 集群添加方式

边缘平台支持两种方式添加集群：

### 方式 1: 导入现有集群（推荐）

适用于已有 Kubernetes 集群的场景。

**优点**：
- ✅ 快速接入
- ✅ 不改变集群配置
- ✅ 支持多集群管理

### 方式 2: 通过安装器创建集群

使用边缘平台提供的安装器创建新集群。

**优点**：
- ✅ 自动化部署
- ✅ 最佳实践配置
- ✅ 集成边缘计算组件

本文档重点介绍**方式 1: 导入现有集群**。

## 📝 步骤 1: 准备 Kubeconfig

### 获取 Kubeconfig 文件

从 Kubernetes 集群获取 kubeconfig 文件：

```bash
# 方式 1: 从主节点复制
scp root@<master-ip>:~/.kube/config ./kubeconfig

# 方式 2: 导出当前配置
kubectl config view --raw > ./kubeconfig

# 方式 3: 使用特定 context
kubectl config view --raw --context=<context-name> > ./kubeconfig
```

### 验证 Kubeconfig

确保 kubeconfig 文件有效：

```bash
# 测试连接
kubectl --kubeconfig=./kubeconfig get nodes

# 检查版本
kubectl --kubeconfig=./kubeconfig version
```

**预期输出**：

```bash
$ kubectl --kubeconfig=./kubeconfig get nodes
NAME       STATUS   ROLES           AGE   VERSION
master-1   Ready    control-plane   10d   v1.28.0
worker-1   Ready    <none>          10d   v1.28.0
worker-2   Ready    <none>          10d   v1.28.0
```

### Kubeconfig 安全处理

:::warning 安全提示
Kubeconfig 包含集群访问凭证，请妥善保管：
- ❌ 不要提交到版本控制系统
- ❌ 不要通过不安全的渠道传输
- ✅ 使用加密存储
- ✅ 定期轮换凭证
:::

## 🖥️ 步骤 2: 在 Console 中添加集群

### 进入集群管理页面

1. 登录边缘平台 Console
2. 点击左侧菜单"平台管理" > "集群管理"
3. 点击右上角"添加集群"按钮

### 填写基本信息

在"添加集群"对话框中填写以下信息：

| 字段 | 说明 | 示例 |
|------|------|------|
| **集群名称*** | 集群的唯一标识 | `prod-cluster` |
| **显示名称** | 在 Console 中显示的名称 | `生产环境集群` |
| **集群描述** | 集群的用途描述 | `生产环境主集群，运行核心业务` |
| **集群类型** | 集群类型选择 | `Kubernetes` / `OpenYurt` |
| **环境标签** | 环境标识 | `生产` / `测试` / `开发` |

:::tip 命名规范
集群名称只能包含小写字母、数字和连字符（-），且必须以字母开头。
:::

### 上传 Kubeconfig

**方式 1: 文件上传**

1. 点击"上传 Kubeconfig"按钮
2. 选择准备好的 kubeconfig 文件
3. 系统会自动解析并验证

**方式 2: 直接粘贴**

1. 点击"直接输入"标签
2. 将 kubeconfig 内容粘贴到文本框
3. 点击"验证"按钮

### 配置高级选项（可选）

展开"高级设置"，可以配置：

| 选项 | 说明 | 默认值 |
|------|------|--------|
| **代理模式** | 是否通过代理访问集群 | 关闭 |
| **同步间隔** | 集群状态同步间隔（秒） | 30 |
| **超时时间** | API 请求超时时间（秒） | 60 |
| **标签** | 自定义集群标签 | - |
| **注解** | 自定义集群注解 | - |

### 验证连接

点击"测试连接"按钮，系统会：

1. ✅ 验证 kubeconfig 格式
2. ✅ 测试集群连通性
3. ✅ 检查必要权限
4. ✅ 获取集群基本信息

### 完成添加

确认所有信息无误后，点击"确定"按钮完成集群添加。

## 🔍 步骤 3: 验证集群状态

### 查看集群列表

在"集群管理"页面，您可以看到刚添加的集群：

```
┌─────────────────────────────────────────────────────────────┐
│ 集群名称        │ 状态  │ 节点  │ Kubernetes 版本 │ 更新时间   │
├─────────────────────────────────────────────────────────────┤
│ prod-cluster   │ 正常  │ 3/3   │ v1.28.0        │ 刚刚       │
└─────────────────────────────────────────────────────────────┘
```

### 集群状态说明

| 状态 | 图标 | 说明 |
|------|------|------|
| **正常** | 🟢 | 集群运行正常，所有节点健康 |
| **告警** | 🟡 | 部分节点或组件异常 |
| **离线** | 🔴 | 无法连接到集群 |
| **同步中** | 🔄 | 正在同步集群状态 |

### 查看集群详情

点击集群名称进入详情页，可以看到：

**概览标签**：

- 📊 集群基本信息
- 📈 资源使用统计
- 🎯 组件健康状态
- 📋 最近事件

**节点标签**：

- 节点列表
- 节点状态
- 资源分配
- 标签和注解

**监控标签**：

- CPU 使用率
- 内存使用率
- 磁盘使用率
- 网络流量

## ⚙️ 步骤 4: 配置集群设置

### 进入集群设置

1. 在集群详情页，点击右上角"设置"按钮
2. 或在集群列表中，点击集群操作菜单 > "设置"

### 基本设置

**更新集群信息**：

```yaml
显示名称: 生产环境主集群
描述: 运行核心业务应用的生产集群
环境: 生产
联系人: ops-team@example.com
```

### 访问控制

**配置集群级别的权限**：

1. 点击"访问控制"标签
2. 点击"添加成员"
3. 选择用户和角色：
   - **集群管理员** - 完全控制权限
   - **集群观察者** - 只读权限
   - **集群开发者** - 部署和管理应用

### 网络配置

**配置集群网络策略**：

| 选项 | 说明 | 推荐值 |
|------|------|--------|
| **Pod CIDR** | Pod 网络范围 | `10.244.0.0/16` |
| **Service CIDR** | Service 网络范围 | `10.96.0.0/12` |
| **DNS 域名** | 集群内部 DNS 域名 | `cluster.local` |

### 集成配置

**配置外部系统集成**：

```yaml
监控系统:
  Prometheus: http://prometheus.edge-system:9090
  Grafana: http://grafana.edge-system:3000

日志系统:
  Loki: http://loki.edge-system:3100

镜像仓库:
  Harbor: https://harbor.example.com
```

## 🎯 步骤 5: 部署边缘组件（OpenYurt）

如果您的集群是 OpenYurt，可以通过 Console 快速部署边缘组件。

### 检查边缘组件

1. 进入集群详情页
2. 点击"边缘节点"标签
3. 查看边缘组件状态：
   - YurtHub
   - YurtManager
   - Raven Controller

### 部署缺失组件

如果某些组件未部署：

1. 点击"部署边缘组件"按钮
2. 选择要部署的组件
3. 配置组件参数
4. 点击"确认"开始部署

### 验证边缘能力

```bash
# 检查边缘节点
kubectl get nodes -l openyurt.io/is-edge-worker=true

# 检查 NodePool
kubectl get nodepools

# 检查 YurtAppSet
kubectl get yurtappsets -A
```

## 📊 步骤 6: 监控集群状态

### 查看监控指标

在集群详情页的"监控"标签，查看：

**资源使用情况**：

```
CPU 使用率:     45%  (18 / 40 核)
内存使用率:     62%  (25GB / 40GB)
Pod 数量:       156  / 500
存储使用率:     38%  (380GB / 1TB)
```

**实时监控图表**：

- 📈 CPU 使用趋势（1小时/6小时/24小时）
- 📈 内存使用趋势
- 📈 网络流量趋势
- 📈 磁盘 I/O 趋势

### 设置告警规则

1. 点击"监控" > "告警规则"
2. 点击"创建告警规则"
3. 配置告警条件：

```yaml
规则名称: 节点 CPU 使用率过高
条件: CPU 使用率 > 80%
持续时间: 5 分钟
通知方式: 邮件 + 站内消息
接收人: ops-team@example.com
```

### 查看事件日志

1. 点击"事件"标签
2. 查看集群最近事件：
   - Pod 创建/删除
   - 节点状态变化
   - 配置更新
   - 错误和警告

## 🔧 常见操作

### 更新 Kubeconfig

如果集群凭证更新：

1. 进入集群设置
2. 点击"更新 Kubeconfig"
3. 上传新的 kubeconfig 文件
4. 点击"保存"

### 刷新集群状态

手动触发集群状态同步：

1. 在集群列表或详情页
2. 点击"刷新"图标
3. 等待同步完成

### 禁用/启用集群

临时禁用集群：

1. 在集群操作菜单中选择"禁用"
2. 禁用后集群不会被监控和管理
3. 需要时选择"启用"恢复

### 移除集群

删除集群管理：

1. 在集群操作菜单中选择"移除"
2. 确认操作（**不会删除实际集群**）
3. 集群将从边缘平台中移除

:::warning 注意
移除集群只是从边缘平台中删除管理关系，不会删除实际的 Kubernetes 集群。
:::

## 🆘 常见问题

### Q: 添加集群时连接测试失败？

**可能原因**：

1. Kubeconfig 文件格式错误
2. 网络不通
3. API Server 地址不可达
4. 证书过期

**排查步骤**：

```bash
# 1. 验证 kubeconfig
kubectl --kubeconfig=./kubeconfig cluster-info

# 2. 测试网络连通性
curl -k https://<api-server-address>:6443

# 3. 检查证书有效期
openssl x509 -in <cert-file> -noout -dates
```

### Q: 集群状态显示"离线"？

**解决方案**：

1. 检查集群 API Server 是否运行
2. 检查网络连通性
3. 验证 kubeconfig 凭证是否有效
4. 查看集群同步日志

```bash
# 查看同步日志
kubectl logs -n edge-system -l app=cluster-controller
```

### Q: 如何添加多集群？

**答**: 重复以上步骤为每个集群添加管理。边缘平台支持管理多个 Kubernetes 集群。

### Q: 可以添加不同版本的 Kubernetes 吗？

**答**: 可以。边缘平台支持 Kubernetes 1.24+ 的所有版本，但推荐使用 1.26+ 版本。

## ✅ 完成检查清单

完成集群添加后，请确认：

- [ ] 集群状态显示为"正常"
- [ ] 可以查看集群节点列表
- [ ] 可以查看集群监控指标
- [ ] 已配置集群访问权限
- [ ] 已设置告警规则（可选）
- [ ] 边缘组件运行正常（OpenYurt 集群）

## 📖 下一步

完成集群添加后，您可以：

- [创建工作空间](../user-guide/workspaces/create.md) - 组织和隔离资源
- [部署应用](../user-guide/applications/deployments.md) - 在集群中运行应用
- [配置监控](../user-guide/observability/metrics.md) - 设置监控和告警
- [管理边缘节点](../user-guide/clusters/edge-nodes.md) - 添加和管理边缘节点

---

**需要帮助？** 请查看 [集群管理详细文档](../user-guide/clusters/overview.md) 或 [故障排查指南](../deployment/troubleshooting.md)。
