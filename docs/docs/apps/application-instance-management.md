# 应用实例管理

## 概述

应用实例管理是指对已部署应用的生命周期管理，包括监控、扩缩容、配置更新、启停控制等操作。通过应用实例管理，可以确保应用稳定运行并满足业务需求。

## 访问应用实例

### 进入应用管理界面

1. **导航到工作空间**
   - 在控制台选择"集群" → "租户空间"
   - 选择目标工作空间

2. **进入项目**
   - 在工作空间中选择"项目管理"
   - 点击目标项目名称

3. **打开应用管理**
   - 在项目左侧导航栏中选择"应用"
   - 进入应用实例管理页面

![项目应用管理](images/project-deployments.png)

## 应用实例列表

### 列表视图

应用实例列表显示以下信息：

- **应用名称**: 实例的名称和显示名称
- **应用类型**: 应用图标和分类
- **状态**: 运行状态（运行中、待定、失败等）
- **副本数**: 当前副本数/期望副本数
- **版本**: 运行的应用版本
- **创建时间**: 实例创建时间

### 筛选和搜索

- **状态筛选**: 按运行状态筛选实例
- **搜索**: 按应用名称搜索实例
- **排序**: 按创建时间、名称等排序

## 应用实例详情

### 查看实例详情

1. **打开实例详情**
   - 在应用列表中点击目标实例
   - 进入实例详情页面

2. **详情页内容**
   - **基本信息**: 应用名称、版本、创建时间等
   - **运行状态**: 副本状态、资源使用情况
   - **配置信息**: 环境变量、配置项、存储卷等
   - **访问信息**: 服务地址、端口等
   - **事件和日志**: 近期事件和操作日志

### 应用状态

#### 实例状态类型

- **运行中**: 所有副本正常运行
- **待定**: 副本正在创建或启动中
- **失败**: 一个或多个副本运行失败
- **停止**: 应用已停止，副本数为0
- **更新中**: 应用正在更新版本或配置

#### 副本状态

- **期望副本数**: 配置的副本数量
- **当前副本数**: 当前运行的副本数量
- **就绪副本数**: 已就绪可提供服务的副本数量
- **最新副本数**: 已更新到最新版本的副本数量

## 应用实例操作

### 扩缩容操作

#### 手动扩缩容

1. **调整副本数量**
   - 在实例详情页点击"扩缩容"
   - 设置新的副本数量
   - 确认执行

2. **扩容场景**
   - 业务增长需要增加处理能力
   - 应对促销活动等流量高峰
   - 提高应用可用性

3. **缩容场景**
   - 业务量下降节省资源
   - 优化资源配置
   - 降低运营成本

#### 自动扩缩容

如果配置了HPA（Horizontal Pod Autoscaler）：

1. **设置扩缩容策略**
   - 定义CPU/内存使用率阈值
   - 设置最小和最大副本数
   - 配置指标采集周期

2. **查看自动扩缩容事件**
   - 在实例事件中查看扩缩容记录
   - 监控副本数量变化趋势
   - 分析自动扩缩容触发原因

### 配置更新

#### 更新应用配置

1. **修改配置参数**
   - 在实例详情页点击"更新配置"
   - 修改环境变量、资源配置等
   - 保存并应用更改

2. **更新策略**
   - **滚动更新**: 逐个更新副本，确保服务不中断
   - **快速更新**: 同时更新所有副本，短暂中断服务
   - **蓝绿部署**: 创建新版本副本，切换流量后删除旧版本

3. **验证更新结果**
   - 检查应用运行状态
   - 验证业务功能正常
   - 监控性能指标

#### 版本升级

1. **升级应用版本**
   - 在实例详情页点击"升级"
   - 选择目标版本
   - 查看版本更新日志
   - 执行升级操作

2. **升级注意事项**
   - 升级前备份数据
   - 检查版本兼容性
   - 在测试环境验证后再升级生产环境
   - 准备回滚方案

### 启停控制

#### 启动应用

1. **启动已停止的应用**
   - 在实例列表中点击"启动"
   - 或在实例详情页点击"启动"
   - 等待副本创建完成

2. **启动验证**
   - 检查副本状态变为"运行中"
   - 验证服务可访问
   - 查看应用日志

#### 停止应用

1. **停止运行中的应用**
   - 在实例列表中点击"停止"
   - 确认停止操作
   - 所有副本将被删除

2. **停止影响**
   - 应用服务将不可用
   - 资源将被释放
   - 配置和数据会被保留

#### 重启应用

1. **重启应用实例**
   - 在实例详情页点击"重启"
   - 确认重启操作
   - 副本将被逐个重启

2. **重启场景**
   - 应用出现异常需要重启恢复
   - 应用配置更改后需要重启生效
   - 定期维护重启

### 删除实例

#### 删除应用实例

1. **删除操作**
   - 在实例列表中点击"删除"
   - 输入实例名称确认删除
   - 等待删除完成

2. **删除影响**
   - 所有副本将被删除
   - 配置资源将被清理
   - 持久卷声明需要手动删除
   - 数据需要提前备份

## 监控和诊断

### 资源监控

#### CPU和内存使用

1. **查看资源使用情况**
   - 在实例详情页查看CPU/内存使用率
   - 查看资源请求和限制
   - 分析资源使用趋势

2. **资源优化**
   - 根据实际使用调整资源配额
   - 避免资源浪费
   - 优化应用性能

#### 存储使用

1. **查看存储使用情况**
   - 查看持久卷挂载情况
   - 监控存储容量使用
   - 预警存储空间不足

### 日志查看

#### 应用日志

1. **查看容器日志**
   - 在实例详情页点击"查看日志"
   - 选择对应的容器和副本
   - 实时查看日志输出

2. **日志筛选**
   - 按时间范围筛选
   - 按关键词搜索
   - 按日志级别筛选

#### 事件日志

1. **查看实例事件**
   - 在实例详情页查看事件列表
   - 查看事件类型和时间
   - 分析事件原因

2. **常见事件类型**
   - **Normal**: 正常操作事件
   - **Warning**: 警告事件，需要关注
   - **Error**: 错误事件，需要处理

### 性能监控

#### 应用性能

1. **响应时间**
   - 监控API响应时间
   - 分析性能瓶颈
   - 优化慢查询

2. **吞吐量**
   - 监控请求处理能力
   - 统计QPS（每秒查询率）
   - 评估系统容量

#### 资源性能

1. **CPU性能**
   - 监控CPU使用率
   - 分析CPU瓶颈
   - 优化CPU密集型操作

2. **内存性能**
   - 监控内存使用情况
   - 检测内存泄漏
   - 优化内存分配

## 故障排查

### 常见问题

#### 应用无法启动

**症状**: 副本状态为CrashLoopBackOff或Error

**可能原因**:
- 应用配置错误
- 依赖服务不可用
- 镜像拉取失败
- 资源不足

**排查步骤**:
1. 查看Pod事件和日志
2. 检查应用配置
3. 验证依赖服务状态
4. 检查资源配额

#### 应用响应缓慢

**症状**: 应用响应时间长，性能下降

**可能原因**:
- 资源不足
- 数据库查询慢
- 网络延迟
- 代码性能问题

**排查步骤**:
1. 查看资源使用情况
2. 分析应用日志
3. 检查数据库性能
4. 进行代码性能分析

#### 应用频繁重启

**症状**: Pod反复重启

**可能原因**:
- 健康检查失败
- 应用异常退出
- OOM（内存溢出）
- 资源限制过低

**排查步骤**:
1. 查看Pod退出码
2. 检查健康检查配置
3. 分析内存使用情况
4. 调整资源限制

### 诊断工具

#### 1. 使用kubectl排查

```bash
# 查看Pod状态
kubectl get pods -n <namespace>

# 查看Pod详情
kubectl describe pod <pod-name> -n <namespace>

# 查看Pod日志
kubectl logs <pod-name> -n <namespace>

# 查看容器日志
kubectl logs <pod-name> -c <container-name> -n <namespace>

# 查看事件
kubectl get events -n <namespace> --sort-by='.lastTimestamp'

# 查看资源使用
kubectl top pods -n <namespace>
```

#### 2. 进入容器调试

```bash
# 进入Pod容器
kubectl exec -it <pod-name> -n <namespace> -- /bin/sh

# 查看进程
kubectl exec -it <pod-name> -n <namespace> -- ps aux

# 查看环境变量
kubectl exec -it <pod-name> -n <namespace> -- env

# 测试网络连接
kubectl exec -it <pod-name> -n <namespace> -- curl http://service-name
```

## 备份和恢复

### 数据备份

#### 备份策略

1. **定期备份**
   - 制定备份计划（每日、每周）
   - 自动化备份流程
   - 验证备份完整性

2. **备份内容**
   - 应用数据
   - 配置信息
   - 持久卷数据

#### 执行备份

1. **手动备份**
   - 在应用维护窗口期执行
   - 停止应用写入操作
   - 备份数据卷

2. **自动备份**
   - 配置定时备份任务
   - 自动备份数据到对象存储
   - 保留多个备份版本

### 数据恢复

#### 恢复流程

1. **准备恢复环境**
   - 创建新的数据卷
   - 部署新应用实例
   - 停止应用访问

2. **执行数据恢复**
   - 从备份恢复数据
   - 验证数据完整性
   - 启动应用服务

3. **验证恢复结果**
   - 检查应用功能
   - 验证数据一致性
   - 监控应用性能

## 最佳实践

### 1. 监控和告警

- **配置监控指标**
  - CPU、内存使用率
  - 应用响应时间
  - 错误率

- **设置告警规则**
  - 资源使用率告警
  - 应用异常告警
  - 服务不可用告警

### 2. 日志管理

- **统一日志格式**
  - 使用JSON格式输出日志
  - 包含时间戳、级别、消息
  - 添加trace ID方便追踪

- **日志轮转**
  - 配置日志大小限制
  - 定期清理旧日志
  - 避免磁盘空间不足

### 3. 变更管理

- **变更流程**
  - 变更申请和审批
  - 在测试环境验证
  - 制定变更计划
  - 执行变更和验证

- **回滚准备**
  - 保留历史版本
  - 备份数据和配置
  - 准备回滚方案

### 4. 安全管理

- **定期更新**
  - 及时更新应用版本
  - 修复安全漏洞
  - 更新依赖库

- **访问控制**
  - 限制应用权限
  - 使用网络策略隔离
  - 定期审计访问日志

## 相关文档

- [应用部署管理](./application-deployment.md)
- [应用商店使用指南](./application-store-guide.md)
- [应用管理概述](./application-management-overview.md)