# 租户空间资源配额管理

## 概述

资源配额（Resource Quota）是租户空间资源管理的核心机制，通过设置CPU、内存、存储等资源的限制，确保资源的合理分配和使用，防止单个租户空间占用过多资源影响其他租户空间。

## 主要功能

- **配额设置**：为租户空间设置资源上限和预留
- **配额分配**：在项目间分配和管理资源配额
- **使用监控**：实时监控资源使用情况
- **超限控制**：防止资源使用超过配额限制

## 资源类型

### 1. 计算资源

#### CPU配额

CPU资源以核心数（Core）为单位计量：

- **预留CPU（Request）**：保证可用的CPU资源
  - 系统确保项目至少能获得这么多CPU资源
  - 用于保证应用的基本性能
  - 设置时需要考虑实际需求

- **CPU上限（Limit）**：最大可使用的CPU资源
  - 项目不能使用超过此限制的CPU
  - 防止应用占用过多CPU资源
  - 建议设置为预留值的1.5-2倍

**配置示例**：
```yaml
cpu:
  request: "4"        # 预留4个CPU核心
  limit: "8"          # 最大使用8个CPU核心
```

#### 内存配额

内存资源以GiB为单位计量：

- **预留内存**：保证可用的内存资源
  - 确保应用有足够的内存运行
  - 避免内存不足导致OOM
  - 需要考虑应用的内存需求

- **内存上限**：最大可使用的内存资源
  - 限制应用的最大内存使用
  - 防止内存泄漏影响其他应用
  - 建议设置为预留值的1.2-1.5倍

**配置示例**：
```yaml
memory:
  request: "8Gi"      # 预留8GiB内存
  limit: "12Gi"       # 最大使用12GiB内存
```

### 2. 存储资源

#### 存储空间配额

限制租户空间可使用的存储空间总量：

- **存储空间上限**：最大存储空间（GB）
- **存储类支持**：支持的存储类型
- **卷数量限制**：可创建的持久卷数量

**配置示例**：
```yaml
storage:
  capacity: "500Gi"      # 最大500GiB存储空间
  storageClass: "standard" # 默认存储类
  persistentVolumeClaims: 10 # 最多10个持久卷
```

### 3. GPU资源（如可用）

对于需要GPU的应用：

- **GPU类型**：可用的GPU型号（如NVIDIA Tesla T4）
- **GPU数量**：可使用的GPU核心数
- **GPU分配策略**：独占或共享使用

**配置示例**：
```yaml
gpu:
  type: "nvidia.com/gpu"
  count: 2              # 2���GPU
  allocation: "exclusive" # 独占模式
```

## 配额层级结构

### 三级配额体系

```
集群总资源
└── 租户空间配额
    └── 项目配额
        └── 容器组配额
```

### 配额分配原则

1. **集群级配额**
   - 平台管理员设置集群的总资源配额
   - 为所有租户空间分配资源

2. **租户空间级配额**
   - 租户空间管理员管理租户空间的资源配额
   - 在项目间分配可用资源

3. **项目级配额**
   - 项目管理员管理项目的资源配额
   - 在应用部署间分配项目资源

## 配额管理界面

### 访问配额管理

1. 进入租户空间设置页面
2. 找到"资源配额"部分
3. 查看和管理各类资源配额

### 配额信息展示

配额管理界面显示以下信息：

#### 总体配额状态
- **总配额**：租户空间的总资源配额
- **已分配**：已分配给项目的资源
- **已使用**：实际正在使用的资源
- **剩余可用**：还可以分配的资源量

#### 使用率图表
- **预留使用率**：已预留资源占总配额的百分比
- **上限使用率**：已使用资源占总配额的百分比
- **趋势图**：资源使用的历史趋势

#### 项目配额列表
- **项目名称**：显示各个项目的名称
- **配额分配**：每个项目分配的资源
- **实际使用**：每个项目实际使用的资源
- **使用率**：每个项目的资源使用率

## 配额配置策略

### 推荐配置策略

#### 1. 保守策略（生产环境）
```yaml
strategy: "conservative"
cpu:
  request: "实际需求的1.2倍"
  limit: "实际需求的1.5倍"
memory:
  request: "实际需求的1.3倍"
  limit: "实际需求的1.6倍"
```

**优点**：
- 保证应用稳定性
- 有足够的缓冲应对流量峰值
- 适合关键业务应用

**缺点**：
- 资源利用率较低
- 成本较高

#### 2. 平衡策略（测试环境）
```yaml
strategy: "balanced"
cpu:
  request: "实际需求的1.0倍"
  limit: "实际需求的1.3倍"
memory:
  request: "实际需求的1.1倍"
  limit: "实际需求的1.4倍"
```

**优点**：
- 兼顾稳定性和资源利用率
- 适合大多数应用场景
- 成本效益较好

**缺点**：
- 在流量峰值时可能出现资源紧张

#### 3. 激进策略（开发环境）
```yaml
strategy: "aggressive"
cpu:
  request: "实际需求的0.8倍"
  limit: "实际需求的1.2倍"
memory:
  request: "实际需求的0.9倍"
  limit: "实际需求的1.3倍"
```

**优点**：
- 资源利用率高
- 成本低
- 适合开发测试环��

**缺点**：
- 可能影响应用性能
- 不适合生产环境

### 不同应用类型的配额建议

#### Web应用
```yaml
cpu:
  request: "0.5"
  limit: "1"
memory:
  request: "1Gi"
  limit: "2Gi"
```

#### API服务
```yaml
cpu:
  request: "1"
  limit: "2"
memory:
  request: "2Gi"
  limit: "4Gi"
```

#### 数据处理
```yaml
cpu:
  request: "4"
  limit: "8"
memory:
  request: "8Gi"
  limit: "16Gi"
```

#### 数据库
```yaml
cpu:
  request: "2"
  limit: "4"
memory:
  request: "4Gi"
  limit: "8Gi"
```

## 配额监控和告警

### 监控指标

重点监控以下指标：

1. **配额使用率**
   - CPU使用率 > 80%：需要关注
   - 内存使用率 > 85%：需要扩容
   - 存储使用率 > 90%：需要清理

2. **资源趋势**
   - 持续增长的资源使用
   - 突然增加的资源消耗
   - 不规律的资源波动

3. **配额分布**
   - 各项目的资源分配比例
   - 资源闲置情况
   - 资源竞争情况

### 告警规则

建议设置以下告警规则：

```yaml
alerts:
  - name: "CPU配额告警"
    condition: "使用率 > 80%"
    severity: "warning"
    action: "通知管理员"

  - name: "内存配额告警"
    condition: "使用率 > 85%"
    severity: "warning"
    action: "通知管理员"

  - name: "存储配额告警"
    condition: "使用率 > 90%"
    severity: "critical"
    action: "立即处理"
```

## 配额优化

### 优化目标

1. **提高资源利用率**
   - 减少资源浪费
   - 提高配额使用效率
   - 降低运营成本

2. **保证应用性能**
   - 确保应用有足够资源
   - 避免资源争抢
   - 维持服务质量

3. **支持业务增长**
   - 预留资源支持业务扩展
   - 灵活调整配额
   - 快速响应需求变化

### 优化方法

#### 1. 资源使用分析

定期分析资源使用情况：

- 识别资源使用低的项目
- 找出资源占用高的应用
- 分析资源使用趋势

#### 2. 配额调整

根据分析结果调整配额：

- 回收闲置资源
- 扩容紧张资源
- 优化配额分配

#### 3. 应用优化

优化应用的资源使用：

- 优化应用代码减少资源消耗
- 调整应用配置提高效率
- 使用资源监控工具

### 优化流程

1. **数据收集**
   - 收集资源使用数据
   - 分析使用模式和趋势
   - 识别优化机会

2. **制定方案**
   - 确定优化目标
   - 制定优化策略
   - 评估优化效果

3. **实施优化**
   - 在测试环境验证
   - 逐步应用到生产环境
   - 监控优化效果

4. **持续改进**
   - 定期评估优化效果
   - 调整优化策略
   - 建立优化机制

## 故障排除

### 常见问题

**Q: 配额不足怎么办？**

A: 解决方法：
1. 分析资源使用情况，找出占用高的项目
2. 优化应用配置，减少资源消耗
3. 申请增加租户空间配额
4. 将部分项目迁移到其他租户空间

**Q: 如何处理配额超限？**

A: 处理步骤：
1. 立即识别超限的项目和应用
2. 暂停非关键应用释放资源
3. 扩容资源配置
4. 优化应用减少资源消耗

**Q: 配额分配不合理？**

A: 优化方法：
1. 分析各项目的实际需求
2. 重新评估配额分配策略
3. 调整项目间的配额分配
4. 建立动态配额调整机制

**Q: 资源使用率低？**

A: 优化建议：
1. 回收闲置资源
2. 合并小项目提高资源利用率
3. 降低不必要的资源预留
4. 部署更多应用利用资源

## 最佳实践

### 配额管理最佳实践

1. **合理设置预留和上限**
   - 预留值应基于实际需求
   - 上限值应预留足够缓冲
   - 定期审查和调整配额

2. **分类管理不同应用**
   - 关键应用：保证充足资源
   - 一般应用：平衡资源分配
   - 临时应用：限制资源使用

3. **建立配额审查机制**
   - 定期审查配额使用情况
   - 及时调整不合理配额
   - 优化资源分配策略

4. **监控和告警**
   - 建立完善的监控体系
   - 设置合理的告警阈值
   - 及时处理资源告警

### 不同环境的配额策略

#### 开发环境
```yaml
development:
  strategy: "shared"
  oversubscription: "200%"
  priority: "low"
  monitoring: "basic"
```

#### 测试环境
```yaml
testing:
  strategy: "balanced"
  oversubscription: "150%"
  priority: "medium"
  monitoring: "standard"
```

#### 生产环境
```yaml
production:
  strategy: "guaranteed"
  oversubscription: "100%"
  priority: "high"
  monitoring: "comprehensive"
```

## 相关功能

资源配额与以下功能相关：

- **租户空间设置**：配置租户空间的资源配额
- **项目管理**：在项目中分配和使用资源
- **监控告警**：监控资源使用情况
- **成本管理**：优化资源使用成本

## 下一步

- 了解如何[配置租户空间设置](./workspace-settings.md)
- 学习如何[管理项目](./workspace-projects.md)
- 配置[监控和告警](./workspace-monitoring.md)
- 查看[成本管理指南](./workspace-costs.md)